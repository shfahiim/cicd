name: CI/CD Pipeline with Automated Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  test:
    name: Run Automated Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Start services for testing
      run: |
        docker compose up -d
        echo "Waiting for services to be ready..."
        sleep 30

    - name: Check service health
      run: |
        echo "Testing User Service..."
        curl -f http://localhost:3002/health || exit 1
        echo "âœ“ User Service is healthy"
        
        echo "Testing Order Service..."
        curl -f http://localhost:3003/health || exit 1
        echo "âœ“ Order Service is healthy"
        
        echo "Testing Product Service..."
        curl -f http://localhost:3004/health || exit 1
        echo "âœ“ Product Service is healthy"

    - name: Run API Tests
      run: |
        # Test User Service
        echo "Creating test user..."
        USER_RESPONSE=$(curl -s -X POST http://localhost:3002/users \
          -H "Content-Type: application/json" \
          -d '{"name":"Test User","email":"test-'$(date +%s)'@example.com"}')
        echo "User Response: $USER_RESPONSE"
        
        # Extract user ID
        USER_ID=$(echo $USER_RESPONSE | grep -o '"_id":"[^"]*"' | cut -d'"' -f4)
        echo "User ID: $USER_ID"
        
        if [ -z "$USER_ID" ]; then
          echo "Failed to create user"
          exit 1
        fi
        echo "âœ“ User created successfully"
        
        # Test Product Service
        echo "Creating test product..."
        PRODUCT_RESPONSE=$(curl -s -X POST http://localhost:3004/products \
          -H "Content-Type: application/json" \
          -d '{"name":"Test Laptop","price":999.99,"stock":100}')
        echo "Product Response: $PRODUCT_RESPONSE"
        
        # Extract product ID
        PRODUCT_ID=$(echo $PRODUCT_RESPONSE | grep -o '"_id":"[^"]*"' | cut -d'"' -f4)
        echo "Product ID: $PRODUCT_ID"
        
        if [ -z "$PRODUCT_ID" ]; then
          echo "Failed to create product"
          exit 1
        fi
        echo "âœ“ Product created successfully"
        
        # Test Order Service (inter-service communication)
        echo "Creating test order..."
        ORDER_RESPONSE=$(curl -s -X POST http://localhost:3003/orders \
          -H "Content-Type: application/json" \
          -d '{"userId":"'"$USER_ID"'","productId":"'"$PRODUCT_ID"'","quantity":2}')
        echo "Order Response: $ORDER_RESPONSE"
        
        # Check if order was created
        ORDER_ID=$(echo $ORDER_RESPONSE | grep -o '"_id":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$ORDER_ID" ]; then
          echo "Failed to create order"
          exit 1
        fi
        echo "âœ“ Order created successfully (inter-service communication working!)"
        
        echo "âœ“ All API tests passed!"

    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== User Service Logs ==="
        docker logs user-service
        echo "=== Product Service Logs ==="
        docker logs product-service
        echo "=== Order Service Logs ==="
        docker logs order-service
        echo "=== MongoDB Logs ==="
        docker logs mongodb

    - name: Stop services
      if: always()
      run: docker compose down

  build-and-push:
    name: Build and Push Docker Images
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and push User Service
      uses: docker/build-push-action@v5
      with:
        context: ./user-service
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/user-service:latest
          ${{ secrets.DOCKER_USERNAME }}/user-service:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/user-service:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/user-service:buildcache,mode=max

    - name: Build and push Product Service
      uses: docker/build-push-action@v5
      with:
        context: ./product-service
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/product-service:latest
          ${{ secrets.DOCKER_USERNAME }}/product-service:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/product-service:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/product-service:buildcache,mode=max

    - name: Build and push Order Service
      uses: docker/build-push-action@v5
      with:
        context: ./order-service
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/order-service:latest
          ${{ secrets.DOCKER_USERNAME }}/order-service:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/order-service:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/order-service:buildcache,mode=max

  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Ubuntu Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # Navigate to application directory
          cd ~/microservices-app || exit 1
          
          # Pull latest images
          echo "Pulling latest Docker images..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/user-service:latest
          docker pull ${{ secrets.DOCKER_USERNAME }}/product-service:latest
          docker pull ${{ secrets.DOCKER_USERNAME }}/order-service:latest
          
          # Stop and remove old containers (except MongoDB)
          echo "Stopping old containers..."
          docker stop user-service product-service order-service 2>/dev/null || true
          docker rm user-service product-service order-service 2>/dev/null || true
          
          # Start services using docker compose
          echo "Starting services..."
          docker compose up -d
          
          # Wait for services to be healthy
          echo "Waiting for services to be healthy..."
          sleep 10
          
          # Show running containers
          echo "Running containers:"
          docker ps
          
          # Check service health
          echo "Checking service health..."
          curl -f http://localhost:3002/health || echo "User service health check failed"
          curl -f http://localhost:3003/health || echo "Order service health check failed"
          curl -f http://localhost:3004/health || echo "Product service health check failed"
          
          echo "Deployment completed successfully!"

    - name: Run Production Smoke Tests
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "Running production smoke tests..."
          
          # Test health endpoints
          echo "Testing health endpoints..."
          curl -f http://localhost:3002/health || exit 1
          echo "âœ“ User Service healthy"
          
          curl -f http://localhost:3003/health || exit 1
          echo "âœ“ Order Service healthy"
          
          curl -f http://localhost:3004/health || exit 1
          echo "âœ“ Product Service healthy"
          
          echo "âœ“ All production health checks passed!"

    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "=== Deployment Verification ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== Service Logs (last 20 lines) ==="
          docker logs --tail 20 user-service
          docker logs --tail 20 product-service
          docker logs --tail 20 order-service
          
    - name: Deployment Summary
      if: success()
      run: |
        echo "ðŸŽ‰ Deployment Successful!"
        echo "================================"
        echo "âœ“ Tests passed"
        echo "âœ“ Images built and pushed"
        echo "âœ“ Deployed to production"
        echo "âœ“ Health checks passed"
        echo ""
        echo "Services available at:"
        echo "â€¢ User Service:    http://${{ secrets.SERVER_HOST }}:3002"
        echo "â€¢ Order Service:   http://${{ secrets.SERVER_HOST }}:3003"
        echo "â€¢ Product Service: http://${{ secrets.SERVER_HOST }}:3004"
